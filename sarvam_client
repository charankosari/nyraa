import os
import logging
from dotenv import load_dotenv
from sarvamai import SarvamAI
from sarvamai.types import AudioFormat
from sarvamai.core.api_error import ApiError

# Load environment variables from .env file
load_dotenv()

# Configure basic logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class SarvamClient:
    """
    Handles:
    - Language Detection
    - Transliteration
    - Translation
    - Text-to-Speech (TTS)
    - Speech-to-Text (STT) Batch Processing
    """
    
    def __init__(self):
        """
        Initializes the client, loading the API key.
        """
        self.api_key = os.getenv("SARVAM_API_KEY")
        if not self.api_key:
            logging.error("SARVAM_API_KEY not found in .env file.")
            raise ValueError("SARVAM_API_KEY must be set in the .env file.")
        
        try:
            self.client = SarvamAI(api_subscription_key=self.api_key)
            logging.info("SarvamClient initialized successfully with sarvamai SDK.")
        except Exception as e:
            logging.error(f"Failed to initialize SarvamAI client: {e}")
            raise

    ### Text Processing APIs ###

    def detect_language(self, text: str):
        """
        Detects the language of the given text using the SDK.
        :param text: The input text string.
        :return: SDK response object or None on failure.
        """
        logging.info(f"Detecting language for text: '{text[:20]}...'")
        try:
            response = self.client.text.identify_language(input=text)
            # The SDK returns a model object, e.g., LanguageIdentificationResponse(language_code='hi-IN', ...)
            return response
        except ApiError as e:
            logging.error(f"API error during language detection: {e.status_code} - {e.body}")
        except Exception as e:
            logging.error(f"Unexpected error during language detection: {e}")
        return None

    def transliterate(self, text: str, source_lang: str, target_lang: str):
        """
        Transliterates text from a source language to a target language.
        :param text: The input text string.
        :param source_lang: Source language code (e.g., 'en-IN').
        :param target_lang: Target language code (e.g., 'hi-IN').
        :return: SDK response object or None on failure.
        """
        logging.info(f"Transliterating '{text}' from {source_lang} to {target_lang}")
        try:
            response = self.client.text.transliterate(
                input=text,
                source_language_code=source_lang,
                target_language_code=target_lang
            )
            # Returns TransliterateTextResponse(transliterated_text='नमस्ते', ...)
            return response
        except ApiError as e:
            logging.error(f"API error during transliteration: {e.status_code} - {e.body}")
        except Exception as e:
            logging.error(f"Unexpected error during transliteration: {e}")
        return None

    def translate(self, text: str, source_lang: str, target_lang: str):
        """
        Translates text from a source language to a target language.
        :param text: The input text string.
        :param source_lang: Source language code (e.g., 'en-IN').
        :param target_lang: Target language code (e.g., 'hi-IN').
        :return: SDK response object or None on failure.
        """
        logging.info(f"Translating '{text}' from {source_lang} to {target_lang}")
        try:
            response = self.client.text.translate(
                input=text,
                source_language_code=source_lang,
                target_language_code=target_lang
            )
            # Returns TranslateTextResponse(translated_text='...', ...)
            return response
        except ApiError as e:
            logging.error(f"API error during translation: {e.status_code} - {e.body}")
        except Exception as e:
            logging.error(f"Unexpected error during translation: {e}")
        return None

    ### Text-to-Speech (TTS) API ###

    def text_to_speech(self, text: str, voice_id: str, output_file_path: str, output_format: AudioFormat = "mp3"):
        """
        Converts text to speech and saves it to a file.
        :param text: The text to synthesize.
        :param voice_id: The voice model to use (e.g., 'anushka').
        :param output_file_path: Path to save the resulting audio file.
        :param output_format: Audio format (e.g., 'mp3', 'wav').
        :return: Boolean True on success, False on failure.
        """
        logging.info(f"Generating TTS for '{text[:20]}...' in voice {voice_id}")
        try:
            # The SDK's TTS method directly supports saving to a file
            response = self.client.text_to_speech.generate(
                input=text,
                voice=voice_id,
                audio_format=output_format,
                output_file=output_file_path
            )
            logging.info(f"Successfully saved TTS audio to {output_file_path}")
            return True
        except ApiError as e:
            logging.error(f"API error during TTS: {e.status_code} - {e.body}")
        except Exception as e:
            logging.error(f"Unexpected error during TTS: {e}")
        return False

    ### Speech-to-Text (STT) Batch API ###

    def speech_to_text_batch(self, file_path: str, language: str, diarization: bool = False):
        """
        Transcribes an audio file using the batch STT API.
        The SDK handles the entire job lifecycle (create, upload, poll, get result).
        
        :param file_path: Path to the local audio file (e.g., 'my_audio.mp3').
        :param language: Language code of the audio (e.g., 'hi-IN').
        :param diarization: Whether to enable speaker diarization.
        :return: The final transcript object, or None on failure.
        """
        logging.info(f"Starting STT batch job for {file_path}")
        
        if not os.path.exists(file_path):
            logging.error(f"File not found: {file_path}")
            return None
            
        try:
            # 1. Create the job configuration
            job = self.client.speech_to_text_job.create_job(
                language_code=language,
                with_diarization=diarization
            )
            logging.info(f"Job created with ID: {job.job_id}")

            # 2. Upload files to the job
            job.upload_files(file_paths=[file_path])
            logging.info("File uploaded successfully.")

            # 3. Start the job
            job.start()
            logging.info("Job started. Waiting for completion...")

            # 4. Wait for the job to complete (SDK handles polling)
            final_status = job.wait_until_complete()
            logging.info(f"Job finished with status: {final_status}")

            if job.is_failed():
                logging.error(f"Job failed. Error: {job.get_error()}")
                return None
            
            # 5. Return the completed job object (which contains the transcript)
            # You can access the transcript via job.get_transcript()
            logging.info("Transcript fetched successfully.")
            return job.get_transcript()

        except ApiError as e:
            logging.error(f"API error during STT batch job: {e.status_code} - {e.body}")
        except Exception as e:
            logging.error(f"An error occurred during STT process: {e}")
            
        return None

# This block allows you to run this file directly for testing
if __name__ == "__main__":
    print("Testing SarvamClient (SDK Version)...")
    
    try:
        client = SarvamClient()
    except Exception as e:
        print(f"Failed to initialize client. Check .env file and API key. Error: {e}")
        exit()

    # --- Test Language Detection ---
    print("\n--- Testing Language Detection ---")
    lang_result = client.detect_language("नमस्ते, दुनिया कैसी है?")
    if lang_result:
        # SDK returns an object, access properties like .language_code
        print(f"Language Detection Result: {lang_result.language_code}") # e.g., 'hi-IN'

    # --- Test Transliteration ---
    print("\n--- Testing Transliteration ---")
    translit_result = client.transliterate(text="namaste", source_lang="en-IN", target_lang="hi-IN")
    if translit_result:
        print(f"Transliteration Result: {translit_result.transliterated_text}") # e.g., 'नमस्ते'

    # --- Test Translation ---
    print("\n--- Testing Translation ---")
    translate_result = client.translate(text="hello, how are you?", source_lang="en-IN", target_lang="hi-IN")
    if translate_result:
        print(f"Translation Result: {translate_result.translated_text}") # e.g., 'नमस्ते आप कैसे हैं?'

    # --- Test Text-to-Speech ---
    print("\n--- Testing Text-to-Speech ---")
    # Voice IDs are specific, e.g., 'anushka'
    # Check Sarvam AI docs for other available voice IDs.
    tts_success = client.text_to_speech(
        text="नमस्ते, यह सर्वम एआई का परीक्षण है।",
        voice_id="anushka", # Using a known voice from Sarvam docs
        output_file_path="test_output_sdk.mp3"
    )
    print(f"TTS file saved: {tts_success}")

    # --- Test Speech-to-Text ---
    print("\n--- Testing Speech-to-Text ---")
    stt_file = "test_output_sdk.mp3" # Use the file generated above
    if tts_success and os.path.exists(stt_file):
        print(f"Testing STT with file: {stt_file}")
        stt_result = client.speech_to_text_batch(
            file_path=stt_file,
            language="hi-IN"
        )
        if stt_result:
            # The result is a SpeechToTextJobTranscript object
            print(f"STT Result (Full): {stt_result}")
            if stt_result.transcripts and len(stt_result.transcripts) > 0:
                print(f"Transcript Text: {stt_result.transcripts[0].transcript}")
        else:
            print("STT Job failed or returned None.")
    else:
        print(f"Skipping STT test: input file '{stt_file}' not found or TTS failed.")